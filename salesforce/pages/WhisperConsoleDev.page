<apex:page >
    <apex:includeScript value="/support/console/42.0/integration.js"/>
    
    <script type="text/javascript">
        var timeSend = null;
        const SUGGESTION_ENDPOINT = 'https://whisper-dev.us-east-1.elasticbeanstalk.com/whisper/suggestions';
        const HEADERS = {
            "Content-Type": "application/json"
        };

        var messageType = {
            'Chasitor': 0,
            'Agent': 1
        };
        var sentMessage = {};
        var chatStartedHandler = function(result) {
            let chatKey = result.chatKey;
            sforce.console.chat.onNewMessage(chatKey, (result) => onNewMessageHandler(result, chatKey));       
        }

        sforce.console.chat.onChatStarted(chatStartedHandler);

        var onNewMessageHandler = function (result, chatKey) {
            timeSend = performance.now();
            document.getElementById('suggestionSection').innerHTML = '';
            let querry = (result.type == 'Chasitor') ?  result.content : sentMessage.url || result.content;

            let data = {
                chatkey: chatKey,
                Querry: querry,
                type: messageType[result.type]
            };

            fetch( SUGGESTION_ENDPOINT, { method: "POST", body: JSON.stringify(data),  headers: HEADERS })
                .then(data => data.json())
                .then(json =>  createAllButtons(json, chatKey))
                .catch( error =>  console.log('Invalid URL, there is no response. Error: ' + error)); 
            sforce.console.setCustomConsoleComponentVisible(true);
        }

        function setAgentInputSuccess(result) {
            if (!result.success) {
                console.log(result)
            } 
        }

        function createAllButtons(json, chatKey) {
            json.forEach( (element) => {    
                createButton(element, chatKey);
            });
            console.log("Execution time: " + (performance.now() - timeSend).toString());
        }

        function createButton(json, chatKey) {
            let btnHTML = Array();
            btnHTML.push('<div class="suggestion" onclick="chooseSuggestionClick(this, \'' +  chatKey + '\')">')
            btnHTML.push('<div class="content">');
            btnHTML.push('<p class="suggestionFrom"><b>From</b> Your assistant Whisper</p>');
            btnHTML.push('<div><b>I Recommand this answer</b></div>');
            btnHTML.push('<div class="sentence">' + json.title + '</div>');
            btnHTML.push('<a class="url" href="#" onclick="openURL(\'' + json.uri + '\')">' + json.uri + '</a>');
            btnHTML.push('</div>');
            btnHTML.push('</div>');
            document.getElementById('suggestionSection').innerHTML += btnHTML.join("");
        }

        function chooseSuggestionClick(html, chatKey) {
            sentMessage.sentence = html.getElementsByClassName('sentence')[0].innerText;
            sentMessage.url = html.getElementsByClassName('url')[0].innerText;   
            setAgentInput(sentMessage,chatKey);
        }

        function setAgentInput(sentMessage, chatKey) {
            let msg = sentMessage.sentence + ' ' + sentMessage.url;
            sforce.console.chat.setAgentInput(chatKey, msg, setAgentInputSuccess);
        } 

        function openURL(url) {
            window.open(url, '_blank');
        }

    </script>
    <style>
        body {
            /* Remove default margin from Console component*/
            margin: 0px !important;
        }
        #whisperHeader {
            background-color:#4388CC;
        }
        #whisperTitle {
            color:#fff;
            text-align: center;
            font-size: 1.2em;
            padding: 6px 0;
            font-weight: bold;
        }
        #suggestionSection a {
            text-decoration: none;
            color :#2f8fe4;
        }
        .suggestion .content {
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .suggestion .sentence {
            margin-bottom: 8px;
        }
        .suggestion:hover {
            cursor: pointer;
            background-color: #eee;
        }
        #suggestionSection .suggestion { 
            padding: 0 15px;
        }
        #suggestionSection .suggestionFrom:not(b) {
            color: #2f8fe4;
        }
        #suggestionSection b {
            color: #000;
        }
        
    </style>
    <div id="whisperWrapper">
        <div id="whisperHeader">
            <div id="whisperTitle">
                Whisper
            </div> 
        </div>
        <div id="suggestionSection">
        </div>
    </div>
</apex:page>