<apex:page >
    <apex:includeScript value="/support/console/41.0/integration.js"/>
    <script type="text/javascript">
        const SUGGESTION_ENDPOINT = 'https://my-json-server.typicode.com/CoveoWhisper/WhisperSalesforce/suggestion';
        const CHAT_VISITOR = 'Chasitor';
        
        var chatStartedHandler = function(result) {
            let chatKey = result.chatKey;
            sforce.console.chat.onNewMessage(chatKey, (result) => onNewMessageHandler(result, chatKey));       
        }

        sforce.console.chat.onChatStarted(chatStartedHandler);

        var onNewMessageHandler = function (result, chatKey) {
            if (result.type == CHAT_VISITOR) {
                fetch( SUGGESTION_ENDPOINT )
                    .then(data => data.json())
                    .then(json =>  createAllButtons(json, chatKey))
                    .catch( error =>  console.log('Invalid URL, there is no response. Error: ' + error));
            }
        }

        function setAgentInputSuccess(result) {
            if (!result.success) {
                console.log(result)
            } 
        }

        function createAllButtons(json, chatKey) {
            json.forEach(element => {
                createButton(element, chatKey);
            });
        }

        function createButton(json, chatKey) {
            let openDiv = '<div onclick="chooseSuggestionClick(this, \'' +  chatKey + '\')">'
            let sentence = '<p class="sentence">' + json.sentence + '</p>';
            let url = '<a class="url" href="' + json.url + '">' + json.url + '</a>';
            let closeDiv = '</div>';
            document.getElementById('suggestionSection').innerHTML += 
                openDiv + sentence + url + closeDiv;
        }

        function chooseSuggestionClick(html, chatKey) {
            let sentence = html.getElementsByClassName('sentence')[0].innerText;
            let url = html.getElementsByClassName('url')[0].innerText;
            setAgentInput(sentence + ' ' + url, chatKey);
        }

        function setAgentInput(msg, chatKey) {
            sforce.console.chat.setAgentInput(chatKey, msg, setAgentInputSuccess);
        } 
    </script>

    <div id="suggestionSection">
    </div>
</apex:page>